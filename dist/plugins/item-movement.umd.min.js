!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).ItemMovement={})}(this,(function(t){"use strict";const i="config.plugin.ItemMovement";class e{constructor(t,i){this.onDestroy=[],this.vido=t,this.state=t.state,this.api=t.api,this.data=function(t={}){const i={onStart:({items:t})=>t.after,onMove:({items:t})=>t.after,onEnd:({items:t})=>t.after},e={start:({startTime:t,time:i})=>t.startOf(i.period)},a=Object.assign({enabled:!0,dependant:!0,debug:!1,state:"",bodyClass:"gstc-items-moving",itemClass:"",initialPosition:{x:0,y:0},currentPosition:{x:0,y:0},movement:{x:0,y:0,time:0},threshold:{horizontal:10,vertical:10},initialItems:[],initialDependant:[],initialItemsData:{},initialDependantData:{},targetData:null,isMoving:!1,triggerDown:!1,events:Object.assign({},i),snapToTime:Object.assign({},e)},t);return t.snapToTime&&(a.snapToTime=Object.assign(Object.assign({},e),t.snapToTime)),t.events&&(a.events=Object.assign(Object.assign({},i),t.events)),a}(i),this.data.itemClass||(this.data.itemClass=this.api.getClass("timeline-chart-items-row-item")+"--moving"),this.destroy=this.destroy.bind(this),this.itemUpdateAction=this.itemUpdateAction.bind(this),this.itemAction=this.itemAction.bind(this),this.updateData(),this.onDestroy.push(this.state.subscribe("config.plugin.ItemMovement",t=>{t.enabled&&t.isMoving?document.body.classList.add(t.bodyClass):document.body.classList.remove(t.bodyClass),this.data=t})),this.onDestroy.push(this.state.update("config.actions.chart-timeline-items-row-item",t=>(t.includes(this.itemAction)||t.push(this.itemAction),t))),this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerMove=t.schedule(this.onPointerMove),this.onPointerUp=this.onPointerUp.bind(this),document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerup",this.onPointerUp)}destroy(){this.state.update("config.actions.chart-timeline-items-row-item",t=>t.filter(t=>t!==this.itemAction)),this.onDestroy.forEach(t=>t()),document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerup",this.onPointerUp)}updateData(){this.state.update(i,this.data)}getSelectedItems(){return this.state.get("config.plugin.Selection.selected.chart-timeline-items-row-item").map(t=>this.api.mergeDeep({},this.api.getItem(t)))}getSelectedItemsData(t){const i={};for(const e of t)i[e.id]=this.api.mergeDeep({},this.api.getItemData(e.id));return i}getEventArgument(t){const i=this.api.getAllItems(),e=[];for(const a of t)e.push(this.api.mergeDeep({},i[a.id]));return{items:{initial:this.data.initialItems,before:e,after:t,targetData:this.data.targetData},vido:this.vido,state:this.state,time:this.state.get("$data.chart.time")}}getDependantItems(){const t=[],i=this.api.getItemsData();for(const e of this.data.initialItems)for(const a of i[e.id].dependant)t.includes(a)||t.push(a);const e=this.state.get("config.chart.items");return t.map(t=>e[t]).map(t=>this.api.mergeDeep({},t))}getDependantItemsData(){const t={},i=this.api.getItemsData();for(const e of this.data.initialDependant)t[e.id]=this.api.mergeDeep({},i[e.id]);return t}moveDependantItems(t,i){if(!this.data.dependant)return i;const e=this.api.getItemsData(),a=this.state.get("config.chart.time");for(const s of t){const t=this.data.initialItems.find(t=>t.id===s.id),n=this.data.initialItemsData[t.id],o=e[s.id];if(o.dependant.length){this.api.getItems(o.dependant);for(const t of o.dependant){const e=this.data.initialDependant.find(i=>i.id===t),s=this.data.initialDependantData[t],d=o.time.endDate.diff(n.time.endDate,"millisecond"),r=s.time.startDate.add(d,"millisecond"),h=s.time.endDate.add(d,"millisecond"),m=o.position.right-s.position.right,p=o.position.viewTop-s.position.viewTop,c=this.data.snapToTime.start({startTime:r,item:this.api.mergeDeep({},e),time:a,movement:{x:m,y:p,time:d},vido:this.vido});i=(i=i.update(`config.chart.items.${t}.time`,t=>(t.start=c.valueOf(),t.end=h.valueOf(),t))).update(`$data.chart.items.${t}.time`,t=>(t.startDate=c,t.endDate=h,t))}}}return i}dispatchEvent(t,i,e=null){"onStart"===t&&this.api.muteMethod("fixOverlapped"),"onEnd"===t&&this.api.unmuteMethod("fixOverlapped"),this.api.muteMethod("fullReload"),i=i.map(t=>this.api.mergeDeep({},t));const a=this.data.events[t](this.getEventArgument(i));let s=this.state.multi();for(const t of a)s=s.update(`config.chart.items.${t.id}.time`,t.time),s=s.update(`config.chart.items.${t.id}.rowId`,t.rowId),e&&(s=s.update("$data.chart.items."+t.id,e[t.id]));"onStart"!==t&&"onMove"!==t||(s=this.moveDependantItems(a,s)),s.done(),this.api.unmuteMethod("fullReload")}getItemsForDiff(){const t=this.getSelectedItems()[0],i=this.data.initialItems.find(i=>i.id===t.id);return{modified:t,original:i}}triggerDown(){const t=this.data.triggerDown;this.data.triggerDown=!1,document.body.classList.add(this.data.bodyClass),this.data.isMoving=!0,this.data.initialItems=this.getSelectedItems(),this.data.initialDependant=this.getDependantItems(),this.data.initialItemsData=this.getSelectedItemsData(this.data.initialItems),this.data.initialDependantData=this.getDependantItemsData(),this.data.targetData=this.api.mergeDeep({},t.target.vido),this.data.currentPosition=Object.assign({},this.data.initialPosition),""!==this.data.state&&"end"!==this.data.state||(this.data.state="move"),this.dispatchEvent("onStart",this.data.initialItems),this.updateData()}onPointerDown(t){if(!this.data.enabled)return;this.data.initialPosition={x:t.screenX,y:t.screenY};const i=t.target,e=this.api.getClass("chart-timeline-items-row-item");let a;a=i.classList.contains(e)?i.vido:i.closest("."+e).vido,this.data.triggerDown=t}moveItemVertically(t,i){const e=this.data.movement.y,a=this.data.initialItemsData[t.id],s=this.api.getVisibleRowsId(),n=this.api.getRows(s);for(const s of n){let n=a.position.viewTop+e;if(n<0&&(n=0),n<=s.$data.position.viewTop){t.rowId=s.id,i.position.viewTop=s.$data.position.viewTop,i.position.top=0;break}}}onPointerMove(t){if(!this.data.enabled)return;const i=Math.abs(t.screenX-this.data.initialPosition.x),e=Math.abs(t.screenY-this.data.initialPosition.y);if(this.data.triggerDown&&(i>this.data.threshold.horizontal||e>this.data.threshold.vertical)&&this.triggerDown(),!this.data.isMoving)return;this.data.triggerDown=!1,t.stopPropagation(),t.preventDefault(),this.data.currentPosition.x=t.screenX,this.data.currentPosition.y=t.screenY,this.data.movement.x=this.data.currentPosition.x-this.data.initialPosition.x,this.data.movement.y=this.data.currentPosition.y-this.data.initialPosition.y;const{original:a,modified:s}=this.getItemsForDiff();if(!a)return;this.data.movement.time=s.time.start-a.time.start,"move"!==this.data.state&&"start"!==this.data.state||(this.data.state="move");const n=this.getSelectedItems(),o={},d=this.data.movement,r=this.state.get("$data.chart.time");for(let t=0,i=n.length;t<i;t++){const i=n[t],e=this.api.mergeDeep({},this.data.initialItemsData[i.id]);this.moveItemVertically(i,e);const a=e.time.endDate.diff(e.time.startDate,"millisecond");e.position.left=e.position.left+d.x;const s=this.api.time.getTimeFromViewOffsetPx(e.position.left,r,!0),h=this.data.snapToTime.start({startTime:this.api.time.date(s),item:i,time:r,movement:d,vido:this.vido}),m=h.add(a,"millisecond");i.time.start=h.valueOf(),i.time.end=m.valueOf(),e.time.startDate=h,e.time.endDate=m,e.position.right=e.position.left+e.width,o[i.id]=e}this.dispatchEvent("onMove",n,o),this.updateData()}onEnd(){const t=this.getSelectedItems();this.dispatchEvent("onEnd",t)}onPointerUp(t){this.data.triggerDown=!1,document.body.classList.remove(this.data.bodyClass),this.data.enabled&&this.data.isMoving&&(t.preventDefault(),t.stopPropagation(),"move"===this.data.state&&(this.data.state="end"),this.data.isMoving=!1,this.onEnd(),this.updateData())}itemUpdateAction(t,i){this.data.initialItems.find(t=>t.id===i.item.id)&&this.data.isMoving?t.classList.add(this.data.itemClass):t.classList.remove(this.data.itemClass)}itemAction(t,i){return t.addEventListener("pointerdown",this.onPointerDown),this.itemUpdateAction(t,i),{update:this.itemUpdateAction,destroy:t=>{t.removeEventListener("pointerdown",this.onPointerDown)}}}}t.Plugin=function(t={}){return function(a){const s=a.state.get(i);s&&(t=a.api.mergeDeep({},t,s));return new e(a,t).destroy}},Object.defineProperty(t,"__esModule",{value:!0})}));
