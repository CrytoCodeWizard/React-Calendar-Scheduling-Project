!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).ItemResizing={})}(this,(function(t){"use strict";
/**
 * TimelinePointer plugin
 *
 * @copyright NEURONET - Rafal Pospiech <https://neuronet.io>
 * @author    Rafal Pospiech <neuronet@neuronet.io>
 * @module    gantt-schedule-timeline-calendar
 * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar
 * @version   3.16.1
 * @released  2022-01-06
 * @license   SEE LICENSE IN LICENSE FILE
 */const i="chart-timeline-items-row-item",e="gstc";
/**
 * Gantt-Schedule-Timeline-Calendar helpers
 *
 * @copyright NEURONET - Rafal Pospiech <https://neuronet.io>
 * @author    Rafal Pospiech <neuronet@neuronet.io>
 * @module    gantt-schedule-timeline-calendar
 * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar
 * @version   3.16.1
 * @released  2022-01-06
 * @license   SEE LICENSE IN LICENSE FILE
 */function s(t,i=""){let s=`gstc__${t}`;return t===e&&(s=e),i?`${s} ${s}--${i.replace(":","-")}`:s}
/**
 * ItemResizing plugin
 *
 * @copyright NEURONET - Rafal Pospiech <https://neuronet.io>
 * @author    Rafal Pospiech <neuronet@neuronet.io>
 * @module    gantt-schedule-timeline-calendar
 * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar
 * @version   3.16.1
 * @released  2022-01-06
 * @license   SEE LICENSE IN LICENSE FILE
 */const a=s("chart-timeline-items-row-item-resizing-handle-content-line");const n="config.plugin.ItemResizing",o="chart-timeline-items-row-item-resizing-handle",h=s(o),d="--left",l="--right";class r{constructor(t,i){this.onDestroy=[],this.scrollWaiting=0,this.vido=t,this.state=t.state,this.api=t.api,this.data=function(t={}){const i={onStart:({items:t})=>t.after,onResize:({items:t})=>t.after,onEnd:({items:t})=>t.after},e={start:({startTime:t,time:i})=>t.startOf(i.period),end:({endTime:t,time:i})=>t.endOf(i.period)},s={width:18,horizontalMargin:0,verticalMargin:0,outside:!1,outsideWidth:14,outsideHorizontalMargin:6,onlyWhenSelected:!0},a=Object.assign({enabled:!0,dependant:!0,debug:!1,state:"",content:null,bodyClass:"gstc-items-resizing",bodyClassLeft:"gstc-items-resizing-left",bodyClassRight:"gstc-items-resizing-right",outsideWidthThreshold:100,movement:{px:0,time:0},initialItems:[],initialDependant:[],initialItemsData:{},initialDependantData:{},initialLeftPx:0,leftIsMoving:!1,rightIsMoving:!1,handle:Object.assign({},s),events:Object.assign({},i),snapToTime:Object.assign({},e),autoScroll:{speed:1,edgeThreshold:50}},t);return t.snapToTime&&(a.snapToTime=Object.assign(Object.assign({},e),t.snapToTime)),t.events&&(a.events=Object.assign(Object.assign({},i),t.events)),t.handle&&(a.handle=Object.assign(Object.assign({},s),t.handle)),t.autoScroll&&(a.autoScroll=Object.assign(Object.assign({},a.autoScroll),t.autoScroll)),a}(i),this.html=t.html,this.data.content||(this.data.content={left:this.html`<div class=${a}></div><div class=${a}></div>`,right:this.html`<div class=${a}></div><div class=${a}></div>`}),this.innerSlot=this.innerSlot.bind(this),this.outerSlot=this.outerSlot.bind(this),this.onRightPointerDown=this.onRightPointerDown.bind(this),this.onRightPointerMove=this.onRightPointerMove.bind(this),this.onRightPointerUp=this.onRightPointerUp.bind(this),this.onLeftPointerDown=this.onLeftPointerDown.bind(this),this.onLeftPointerMove=this.onLeftPointerMove.bind(this),this.onLeftPointerUp=this.onLeftPointerUp.bind(this),this.destroy=this.destroy.bind(this),this.updateData(),this.onDestroy.push(this.state.subscribe("$data.elements.chart-timeline",(t=>this.timelineElement=t))),this.onDestroy.push(this.state.subscribe("config.plugin.ItemResizing",(t=>{t.enabled?document.body.classList.add(t.bodyClass):document.body.classList.remove(t.bodyClass),this.data=t}))),this.onDestroy.push(this.state.subscribe("config.plugin.TimelinePointer",(t=>{this.pointerData=t,this.onPointerData()}))),this.state.update("config.slots.chart-timeline-items-row-item.inner",(t=>(t.includes(this.innerSlot)||t.push(this.innerSlot),t))),this.state.update("config.slots.chart-timeline-items-row-item.outer",(t=>(t.includes(this.outerSlot)||t.push(this.outerSlot),t)))}destroy(){this.onDestroy.forEach((t=>t())),this.state.update("config.slots.chart-timeline-items-row-item.inner",(t=>t.filter((t=>t!==this.innerSlot)))),this.state.update("config.slots.chart-timeline-items-row-item.outer",(t=>t.filter((t=>t!==this.outerSlot)))),this.api.pluginDestroyed("ItemResizing")}updateData(){this.state.update(n,this.data)}setUpClasses(t=!1){this.leftClassName=this.api.getClass(o),this.leftClassName+=" "+this.leftClassName+d,this.rightClassName=this.api.getClass(o),this.rightClassName+=" "+this.rightClassName+l,t&&(this.leftClassName+=` ${this.api.getClass(o)}--left-outside`,this.rightClassName+=` ${this.api.getClass(o)}--right-outside`)}getSelectedItems(){return this.state.get(`config.plugin.Selection.selected.${i}`).map((t=>this.api.mergeDeep({},this.api.getItem(t))))}getSelectedItemsData(t){const i={};for(const e of t)i[e.id]=this.api.mergeDeep({},this.api.getItemData(e.id));return i}updateRightStyleMap(t,i){const e=this.api.getItemData(t.id);return i.style.top="0px",this.data.handle.outside||e.actualWidth<this.data.outsideWidthThreshold?(i.style.position="absolute",i.style.left=e.position.actualRight+this.data.handle.outsideHorizontalMargin+"px",i.style.width=this.data.handle.outsideWidth+"px",i.style.top=e.position.actualRowTop+"px",this.setUpClasses(!0)):(i.style.position="static",i.style.width=this.data.handle.width+"px",this.setUpClasses(!1)),i.style.height=e.actualHeight-2*this.data.handle.verticalMargin+"px",e.position.right!==e.position.actualRight?i.style.display="none":i.style.display="flex",i}updateLeftStyleMap(t,i){const e=this.api.getItemData(t.id);return i.style.top="0px",this.data.handle.outside||e.actualWidth<this.data.outsideWidthThreshold?(i.style.position="absolute",i.style.left=e.position.actualLeft-(this.data.handle.outsideWidth+this.data.handle.outsideHorizontalMargin)+"px",i.style.width=this.data.handle.outsideWidth+"px",i.style.top=e.position.actualRowTop+"px",this.setUpClasses(!0)):(i.style.position="static",i.style.left=this.data.handle.horizontalMargin+"px",i.style.width=this.data.handle.width+"px",this.setUpClasses(!1)),i.style.height=e.actualHeight-2*this.data.handle.verticalMargin+"px",e.position.left!==e.position.actualLeft?i.style.display="none":i.style.display="flex",i}getEventArgument(t){const i=this.api.getAllItems(),e=[];for(const s of t)e.push(this.api.mergeDeep({},i[s.id]));return{items:{initial:this.data.initialItems,before:e,after:t},vido:this.vido,state:this.state,time:this.state.get("$data.chart.time")}}getDependantItems(){const t=[],i=this.api.getItemsData();for(const e of this.data.initialItems)for(const s of i[e.id].dependant)t.includes(s)||t.push(s);const e=this.state.get("config.chart.items");return t.map((t=>e[t])).map((t=>this.api.mergeDeep({},t)))}getDependantItemsData(){const t={},i=this.api.getItemsData();for(const e of this.data.initialDependant)t[e.id]=this.api.mergeDeep({},i[e.id]);return t}moveDependantItems(t,i){if(!this.data.dependant)return i;const e=this.api.getItemsData(),s=this.state.get("config.chart.time");for(const a of t){const t=this.data.initialItems.find((t=>t.id===a.id)),n=this.data.initialItemsData[t.id],o=e[a.id];if(o.dependant.length)for(const t of o.dependant){const e=this.data.initialDependant.find((i=>i.id===t)),a=this.data.initialDependantData[t],h=o.time.endDate.diff(n.time.endDate,"millisecond"),d=a.time.startDate.add(h,"millisecond"),l=a.time.endDate.add(h,"millisecond"),r=o.position.right-a.position.right,p=this.data.snapToTime.start({startTime:d,item:this.api.mergeDeep({},e),time:s,movement:{px:r,time:h},vido:this.vido}),c=this.data.snapToTime.end({endTime:l,item:this.api.mergeDeep({},e),time:s,movement:{px:r,time:h},vido:this.vido});i=i.update(`config.chart.items.${t}.time`,(t=>(t.start=p.valueOf(),t.end=c.valueOf(),t))),i=i.update(`$data.chart.items.${t}.time`,(t=>(t.startDate=p,t.endDate=c,t)))}}return i}dispatchEvent(t,i,e=null){"onStart"===t&&(this.api.muteMethod("fixOverlapped"),this.api.muteMethod("fullReload"),this.api.muteMethod("recalculateRowPercents"),this.api.muteMethod("getLastPageRowsHeight"),this.api.muteMethod("calculateVerticalScrollArea"),this.api.muteMethod("heightChange"),this.api.muteMethod("calculateRowsHeight"),this.api.muteMethod("updateVisibleItemsListener"),this.api.muteMethod("prepareExpanded"),0===this.data.autoScroll.speed&&0===this.data.autoScroll.speed&&(this.api.muteMethod("generateVisibleRowsAndItems"),this.api.muteMethod("calculateVisibleRowsHeights"),this.api.muteMethod("prepareExpanded"),this.api.muteMethod("recalculateTimes"))),"onEnd"===t&&(this.api.unmuteMethod("fixOverlapped"),this.api.unmuteMethod("heightChange"),this.api.unmuteMethod("calculateVerticalScrollArea"),this.api.unmuteMethod("getLastPageRowsHeight"),this.api.unmuteMethod("recalculateRowPercents"),this.api.unmuteMethod("fullReload"),this.api.unmuteMethod("calculateRowsHeight"),this.api.unmuteMethod("updateVisibleItemsListener"),this.api.unmuteMethod("prepareExpanded"),0===this.data.autoScroll.speed&&0===this.data.autoScroll.speed&&(this.api.unmuteMethod("generateVisibleRowsAndItems"),this.api.unmuteMethod("calculateVisibleRowsHeights"),this.api.unmuteMethod("prepareExpanded"),this.api.unmuteMethod("recalculateTimes"))),i=i.map((t=>this.api.mergeDeep({},t)));const s=this.data.events[t](this.getEventArgument(i));let a=this.state.multi(!0);const n=this.state.get("config.chart.items");let o=!1;for(const t of s){let i=!1;const s=n[t.id];t.time.start===s.time.start&&t.time.end===s.time.end||(o=!0,i=!0,a=a.update(`config.chart.items.${t.id}.time`,t.time)),e&&i&&(a=a.update(`$data.chart.items.${t.id}`,(i=>(i.time=Object.assign(Object.assign({},i.time),e[t.id].time),i.position=Object.assign(Object.assign({},i.position),e[t.id].position),i))))}o&&(a=this.moveDependantItems(s,a)),a.done(),"onEnd"===t&&this.api.main.partialReload(!1)}getItemsForDiff(){const t=this.getSelectedItems()[0],i=this.data.initialItems.find((i=>i.id===t.id));return{modified:t,original:i}}onPointerData(){this.data.enabled&&("down"===this.pointerData.pointerState&&this.pointerData.targetType===i?this.api.plugins.TimelinePointer.isLocked("down")||this.onPointerDown():"move"===this.pointerData.pointerState&&this.pointerData.targetType===i?"item-resizing"===this.api.plugins.TimelinePointer.isLocked("move")&&this.onPointerMove():"up"===this.pointerData.pointerState&&this.pointerData.targetType===i&&"item-resizing"===this.api.plugins.TimelinePointer.isLocked("up")&&this.onPointerUp())}onPointerDown(){const t=this.pointerData.currentTarget.closest("."+h);t&&!this.api.plugins.TimelinePointer.isLocked("down")&&(this.api.plugins.TimelinePointer.lock("down","item-resizing"),this.api.plugins.TimelinePointer.lock("move","item-resizing"),this.api.plugins.TimelinePointer.lock("up","item-resizing"),this.pointerData.events.down.preventDefault(),this.pointerData.events.down.stopPropagation(),this.data.initialLeftPx=this.state.get("$data.chart.time.leftPx"),this.data.initialItems=this.getSelectedItems(),this.data.initialDependant=this.getDependantItems(),this.data.initialItemsData=this.getSelectedItemsData(this.data.initialItems),this.data.initialDependantData=this.getDependantItemsData(),""!==this.data.state&&"end"!==this.data.state||(this.data.state="resize"),t.classList.contains(h+d)&&this.onLeftPointerDown(),t.classList.contains(h+l)&&this.onRightPointerDown(),this.dispatchEvent("onStart",this.data.initialItems))}onLeftPointerDown(){this.data.enabled&&(document.body.classList.add(this.data.bodyClassLeft),this.data.leftIsMoving=!0,this.updateData())}onRightPointerDown(){this.data.enabled&&(document.body.classList.add(this.data.bodyClassRight),this.data.rightIsMoving=!0,this.updateData())}getScrollDiff(){return this.state.get("$data.chart.time.leftPx")-this.data.initialLeftPx}scrollLeft(){if(this.data.autoScroll.speed&&!this.state.get("config.chart.time.calculatedZoomMode")){if(this.scrollWaiting++,this.data.autoScroll.speed<0){if(this.scrollWaiting-1<Math.abs(this.data.autoScroll.speed))return;const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex-1)}else if(this.data.autoScroll.speed>0){const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex-this.data.autoScroll.speed)}this.scrollWaiting=0}}scrollRight(){if(this.data.autoScroll.speed&&!this.state.get("config.chart.time.calculatedZoomMode")){if(this.scrollWaiting++,this.data.autoScroll.speed<0){if(this.scrollWaiting-1<Math.abs(this.data.autoScroll.speed))return;const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex+1)}else if(this.data.autoScroll.speed>0){const t=this.api.getScrollLeft();this.api.setScrollLeft(t.dataIndex+this.data.autoScroll.speed)}this.scrollWaiting=0}}autoScroll(){if(!this.timelineElement)return;const t=this.pointerData.currentPosition.x,i=this.timelineElement.getBoundingClientRect();t<this.data.autoScroll.edgeThreshold?this.scrollLeft():t>i.width-this.data.autoScroll.edgeThreshold&&this.scrollRight()}onPointerMove(){if(!this.data.enabled)return;const{original:t,modified:i}=this.getItemsForDiff();t&&(this.data.movement={px:this.pointerData.movement.x,time:i.time.start-t.time.start},"resize"!==this.data.state&&"start"!==this.data.state||(this.data.state="resize"),this.autoScroll(),this.data.leftIsMoving&&this.onLeftPointerMove(),this.data.rightIsMoving&&this.onRightPointerMove())}onLeftPointerMove(){if(!this.data.enabled||!this.data.leftIsMoving)return;const t=this.getSelectedItems(),i={},e=this.data.movement,s=this.state.get("$data.chart.time");for(let a=0,n=t.length;a<n;a++){const n=t[a],o=this.api.mergeDeep({},this.data.initialItemsData[n.id]),h=this.getScrollDiff();o.position.right+=-1*h,o.position.left=o.position.left+e.px,o.position.left>o.position.right-n.minWidth&&(o.position.left=o.position.right-n.minWidth);const d=this.api.time.getTimeFromOffsetPx(o.position.left,!0,s);o.width=o.position.right-o.position.left,o.width<n.minWidth&&(o.width=n.minWidth),o.actualWidth=o.width;const l=this.data.snapToTime.start({startTime:this.api.time.date(d),item:n,time:s,movement:e,vido:this.vido});n.time.start=l.valueOf(),o.time.startDate=l,i[n.id]=o}this.dispatchEvent("onResize",t,i),this.updateData()}onRightPointerMove(){if(!this.data.enabled||!this.data.rightIsMoving)return;const t=this.getSelectedItems(),i={},e=this.data.movement,s=this.state.get("$data.chart.time");for(let a=0,n=t.length;a<n;a++){const n=t[a],o=this.api.mergeDeep({},this.data.initialItemsData[n.id]),h=this.getScrollDiff();o.position.left+=-1*h,o.position.right=o.position.right+e.px,o.position.right<o.position.left+n.minWidth&&(o.position.right=o.position.left+n.minWidth);const d=this.api.time.getTimeFromOffsetPx(o.position.right,!0,s);o.width=o.position.right-o.position.left,o.width<n.minWidth&&(o.width=n.minWidth),o.actualWidth=o.width;const l=this.data.snapToTime.end({endTime:this.api.time.date(d),item:n,time:s,movement:e,vido:this.vido});n.time.end=l.valueOf(),o.time.endDate=l,i[n.id]=o}this.dispatchEvent("onResize",t,i),this.updateData()}onEnd(){const t=this.getSelectedItems();this.dispatchEvent("onEnd",t)}onPointerUp(){"resize"===this.data.state&&(this.data.state="end"),this.onLeftPointerUp(),this.onRightPointerUp(),this.onEnd(),this.updateData(),this.api.plugins.TimelinePointer.unlock("down"),this.api.plugins.TimelinePointer.unlock("move"),this.api.plugins.TimelinePointer.unlock("up")}onLeftPointerUp(){document.body.classList.remove(this.data.bodyClassLeft),this.data.enabled&&this.data.leftIsMoving&&(this.data.leftIsMoving=!1,this.onEnd(),this.updateData())}onRightPointerUp(){document.body.classList.remove(this.data.bodyClassRight),this.data.enabled&&this.data.rightIsMoving&&(this.data.rightIsMoving=!1)}innerSlot(t,i){let e,s,a;const n=new t.StyleMap({}),o=new t.StyleMap({});return t.onChange((h=>{if(!(i=h)||!i.item)return;const d=i.item;if(!d)return;const l=this.api.getItemData(d.id);if(!l)return;let r;e=!l.detached,this.data.handle.onlyWhenSelected&&(e=e&&l.selected),e=e&&!(this.data.handle.outside||l.actualWidth<this.data.outsideWidthThreshold),this.updateRightStyleMap(d,o),this.updateLeftStyleMap(d,n),r="function"==typeof this.data.content?this.data.content({item:d,vido:t}):"object"!=typeof this.data.content||"left"in this.data.content?this.data.content:{left:this.data.content,right:this.data.content},s=this.html`<div class=${this.leftClassName} data-gstcid=${i.item.id} style=${n.directive()}>${r.left}</div>`,a=this.html`<div class=${this.rightClassName} data-gstcid=${i.item.id} style=${o.directive()}>${r.right}</div>`,t.update()})),t=>this.html`${e?s:null}${t}${e?a:null}`}outerSlot(t,e){let s,a,n;const o=new t.StyleMap({}),h=new t.StyleMap({});return t.onChange((d=>{if(!(e=d)||!e.item)return;const l=e.item;if(!l)return;const r=this.api.getItemData(l.id);if(!r)return;let p;s=!r.detached,this.data.handle.onlyWhenSelected&&(s=s&&r.selected),s=s&&(this.data.handle.outside||r.actualWidth<this.data.outsideWidthThreshold),this.updateRightStyleMap(l,h),this.updateLeftStyleMap(l,o),p="function"==typeof this.data.content?this.data.content({item:l,vido:t}):"object"!=typeof this.data.content||"left"in this.data.content?this.data.content:{left:this.data.content,right:this.data.content},a=this.html`<div class=${this.leftClassName} data-type=${i} data-gstcid=${e.item.id} style=${o.directive()}>${p.left}</div>`,n=this.html`<div class=${this.rightClassName} data-type=${i} data-gstcid=${e.item.id} style=${h.directive()}>${p.right}</div>`,t.update()})),t=>this.html`${s?a:null}${t}${s?n:null}`}}t.Plugin=function(t={}){return function(i){const e=i.api;if(!e.isPluginInitialized("TimelinePointer"))throw new Error("TimelinePointer plugin must be initialized before ItemResizing plugin.");if(!e.isPluginInitialized("Selection"))throw new Error("Selection plugin must be initialized before ItemResizing plugin.");if(e.isPluginInitialized("ItemMovement"))throw new Error("ItemResizing plugin must be initialized before ItemMovement plugin.");const s=i.state.get(n);s&&(t=i.api.mergeDeep({},t,s));const a=new r(i,t);return e.pluginInitialized("ItemResizing"),a.destroy}},Object.defineProperty(t,"__esModule",{value:!0})}));